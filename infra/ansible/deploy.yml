---
- name: Deploy SecretShare to dev VM
  hosts: devserver
  vars_files:
    - "{{ ansible_controll_vars | default('../../ansible-controll/inventory/group_vars/all.yml') }}"
  vars:
    app_name: secret-share
    app_repo: https://github.com/jprofessionals/secret-share.git
    app_branch: main
    app_dir: /home/deploy/secret-share
    frontend_dir: /var/www/secret-share
    container_name: secret-share-backend
    container_port: 3000
    domain: "secret.{{ domain | default('jpro.dev') }}"
    database_url: "postgres://secret_share:{{ vault_secret_share_db_password }}@127.0.0.1:5432/secret_share_db"
    base_url: "https://{{ domain }}"
    rust_log: "info,secret_share_backend=debug"
    max_secret_days: 30
    max_secret_views: 100
    max_failed_attempts: 10

  tasks:
    - name: Clone or update repository
      ansible.builtin.git:
        repo: "{{ app_repo }}"
        dest: "{{ app_dir }}"
        version: "{{ app_branch }}"
        force: true

    - name: Build backend Docker image
      community.docker.docker_image:
        name: "{{ app_name }}-backend"
        tag: latest
        source: build
        build:
          path: "{{ app_dir }}/backend"
        force_source: true

    - name: Stop existing backend container
      community.docker.docker_container:
        name: "{{ container_name }}"
        state: absent

    - name: Start backend container
      community.docker.docker_container:
        name: "{{ container_name }}"
        image: "{{ app_name }}-backend:latest"
        state: started
        restart_policy: unless-stopped
        network_mode: host
        env:
          DATABASE_URL: "{{ database_url }}"
          BASE_URL: "{{ base_url }}"
          PORT: "{{ container_port | string }}"
          RUST_LOG: "{{ rust_log }}"
          MAX_SECRET_DAYS: "{{ max_secret_days | string }}"
          MAX_SECRET_VIEWS: "{{ max_secret_views | string }}"
          MAX_FAILED_ATTEMPTS: "{{ max_failed_attempts | string }}"

    - name: Install Node.js (if not present)
      become: true
      ansible.builtin.apt:
        name:
          - nodejs
          - npm
        state: present

    - name: Install frontend dependencies
      community.general.npm:
        path: "{{ app_dir }}/frontend"
        ci: true

    - name: Build frontend
      ansible.builtin.command:
        cmd: npm run build
        chdir: "{{ app_dir }}/frontend"
      environment:
        VITE_API_URL: ""

    - name: Create frontend directory
      become: true
      ansible.builtin.file:
        path: "{{ frontend_dir }}"
        state: directory
        owner: deploy
        group: deploy
        mode: "0755"

    - name: Deploy frontend files
      ansible.posix.synchronize:
        src: "{{ app_dir }}/frontend/dist/"
        dest: "{{ frontend_dir }}/"
        delete: true
        recursive: true
      delegate_to: "{{ inventory_hostname }}"

    - name: Write Caddy site config
      ansible.builtin.copy:
        dest: "/etc/caddy/sites/{{ app_name }}.caddy"
        content: |
          {{ domain }} {
              handle /api/* {
                  reverse_proxy localhost:{{ container_port }}
              }
              handle {
                  root * {{ frontend_dir }}
                  try_files {path} /index.html
                  file_server
              }
          }
        mode: "0644"

    - name: Wait for backend health check
      ansible.builtin.uri:
        url: "http://localhost:{{ container_port }}/health"
        status_code: 200
      register: health
      retries: 15
      delay: 2
      until: health.status == 200

    - name: Reload Caddy
      ansible.builtin.command:
        cmd: sudo systemctl reload caddy
      changed_when: true

    - name: Create cleanup systemd service
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/secret-share-cleanup.service
        content: |
          [Unit]
          Description=SecretShare cleanup expired secrets
          Requires=docker.service
          After=docker.service

          [Service]
          Type=oneshot
          ExecStart=/usr/bin/docker exec {{ container_name }} /app/cleanup
          User=deploy
        mode: "0644"

    - name: Create cleanup systemd timer
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/secret-share-cleanup.timer
        content: |
          [Unit]
          Description=Run SecretShare cleanup daily

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
        mode: "0644"

    - name: Enable and start cleanup timer
      become: true
      ansible.builtin.systemd:
        name: secret-share-cleanup.timer
        enabled: true
        state: started
        daemon_reload: true
