---
- name: Deploy SecretShare to dev VM
  hosts: devserver
  vars_files:
    - "{{ ansible_controll_vars | default('../../ansible-controll/inventory/group_vars/all.yml') }}"
  vars:
    app_name: secret-share
    app_dir: /home/deploy/secret-share
    frontend_dir: /var/www/secret-share
    backend_port: 3000
    domain: "secret.{{ domain | default('jpro.dev') }}"
    database_url: "postgres://secret_share:{{ vault_secret_share_db_password }}@127.0.0.1:5432/secret_share_db"
    base_url: "https://{{ domain }}"
    rust_log: "info,secret_share_backend=debug"
    max_secret_days: 30
    max_secret_views: 100
    max_failed_attempts: 10

  tasks:
    - name: Create frontend directory
      become: true
      ansible.builtin.file:
        path: "{{ frontend_dir }}"
        state: directory
        owner: deploy
        group: deploy
        mode: "0755"

    - name: Deploy frontend files
      ansible.posix.synchronize:
        src: "{{ app_dir }}/frontend/"
        dest: "{{ frontend_dir }}/"
        delete: true
        recursive: true
      delegate_to: "{{ inventory_hostname }}"

    - name: Create backend systemd service
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/secret-share.service
        content: |
          [Unit]
          Description=SecretShare Backend
          After=network.target postgresql.service

          [Service]
          Type=simple
          User=deploy
          WorkingDirectory={{ app_dir }}
          ExecStart={{ app_dir }}/secret-share-backend
          Restart=on-failure
          RestartSec=5
          Environment=DATABASE_URL={{ database_url }}
          Environment=BASE_URL={{ base_url }}
          Environment=PORT={{ backend_port }}
          Environment=RUST_LOG={{ rust_log }}
          Environment=MAX_SECRET_DAYS={{ max_secret_days }}
          Environment=MAX_SECRET_VIEWS={{ max_secret_views }}
          Environment=MAX_FAILED_ATTEMPTS={{ max_failed_attempts }}

          [Install]
          WantedBy=multi-user.target
        mode: "0644"
      notify: Restart backend

    - name: Enable and start backend service
      become: true
      ansible.builtin.systemd:
        name: secret-share.service
        enabled: true
        state: started
        daemon_reload: true

    - name: Write Caddy site config
      ansible.builtin.copy:
        dest: "/etc/caddy/sites/{{ app_name }}.caddy"
        content: |
          {{ domain }} {
              handle /api/* {
                  reverse_proxy localhost:{{ backend_port }}
              }
              handle {
                  root * {{ frontend_dir }}
                  try_files {path} /index.html
                  file_server
              }
          }
        mode: "0644"

    - name: Reload Caddy
      ansible.builtin.command:
        cmd: sudo systemctl reload caddy
      changed_when: true

    - name: Wait for backend health check
      ansible.builtin.uri:
        url: "http://localhost:{{ backend_port }}/health"
        status_code: 200
      register: health
      retries: 15
      delay: 2
      until: health.status == 200

    - name: Create cleanup systemd service
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/secret-share-cleanup.service
        content: |
          [Unit]
          Description=SecretShare cleanup expired secrets
          After=network.target postgresql.service

          [Service]
          Type=oneshot
          User=deploy
          WorkingDirectory={{ app_dir }}
          ExecStart={{ app_dir }}/cleanup
          Environment=DATABASE_URL={{ database_url }}
          Environment=RUST_LOG=info
        mode: "0644"

    - name: Create cleanup systemd timer
      become: true
      ansible.builtin.copy:
        dest: /etc/systemd/system/secret-share-cleanup.timer
        content: |
          [Unit]
          Description=Run SecretShare cleanup daily

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
        mode: "0644"

    - name: Enable and start cleanup timer
      become: true
      ansible.builtin.systemd:
        name: secret-share-cleanup.timer
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Restart backend
      become: true
      ansible.builtin.systemd:
        name: secret-share.service
        state: restarted
        daemon_reload: true
