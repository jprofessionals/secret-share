---
- name: Deploy SecretShare to dev VM
  hosts: devserver
  vars_files:
    - "{{ ansible_controll_vars | default('../../ansible-controll/inventory/group_vars/all.yml') }}"
  vars:
    app_name: secret-share
    app_dir: /home/deploy/secret-share
    frontend_dir: /home/deploy/secret-share/frontend
    backend_port: 3000
    domain: "secret.{{ domain | default('jpro.dev') }}"
    database_url: "postgres://secret_share:{{ vault_secret_share_db_password }}@127.0.0.1:5432/secret_share_db"
    base_url: "https://{{ domain }}"
    rust_log: "info,secret_share_backend=debug"
    max_secret_days: 30
    max_secret_views: 100
    max_failed_attempts: 10

  tasks:
    - name: Write backend systemd service file
      ansible.builtin.copy:
        dest: /tmp/secret-share.service
        content: |
          [Unit]
          Description=SecretShare Backend
          After=network.target postgresql.service

          [Service]
          Type=simple
          User=deploy
          WorkingDirectory={{ app_dir }}
          ExecStart={{ app_dir }}/secret-share-backend
          Restart=on-failure
          RestartSec=5
          Environment=DATABASE_URL={{ database_url }}
          Environment=BASE_URL={{ base_url }}
          Environment=PORT={{ backend_port }}
          Environment=RUST_LOG={{ rust_log }}
          Environment=MAX_SECRET_DAYS={{ max_secret_days }}
          Environment=MAX_SECRET_VIEWS={{ max_secret_views }}
          Environment=MAX_FAILED_ATTEMPTS={{ max_failed_attempts }}

          [Install]
          WantedBy=multi-user.target
        mode: "0644"

    - name: Write cleanup systemd service file
      ansible.builtin.copy:
        dest: /tmp/secret-share-cleanup.service
        content: |
          [Unit]
          Description=SecretShare cleanup expired secrets
          After=network.target postgresql.service

          [Service]
          Type=oneshot
          User=deploy
          WorkingDirectory={{ app_dir }}
          ExecStart={{ app_dir }}/cleanup
          Environment=DATABASE_URL={{ database_url }}
          Environment=RUST_LOG=info
        mode: "0644"

    - name: Write cleanup systemd timer file
      ansible.builtin.copy:
        dest: /tmp/secret-share-cleanup.timer
        content: |
          [Unit]
          Description=Run SecretShare cleanup daily

          [Timer]
          OnCalendar=daily
          Persistent=true

          [Install]
          WantedBy=timers.target
        mode: "0644"

    - name: Install systemd service files
      ansible.builtin.shell: |
        sudo cp /tmp/secret-share.service /etc/systemd/system/
        sudo cp /tmp/secret-share-cleanup.service /etc/systemd/system/
        sudo cp /tmp/secret-share-cleanup.timer /etc/systemd/system/
        rm /tmp/secret-share.service /tmp/secret-share-cleanup.service /tmp/secret-share-cleanup.timer
      changed_when: true

    - name: Reload systemd and restart backend
      ansible.builtin.shell: |
        sudo systemctl daemon-reload
        sudo systemctl enable secret-share.service
        sudo systemctl restart secret-share.service
        sudo systemctl enable secret-share-cleanup.timer
        sudo systemctl start secret-share-cleanup.timer
      changed_when: true

    - name: Write Caddy site config
      ansible.builtin.copy:
        dest: "/etc/caddy/sites/{{ app_name }}.caddy"
        content: |
          {{ domain }} {
              handle /api/* {
                  reverse_proxy localhost:{{ backend_port }}
              }
              handle {
                  root * {{ frontend_dir }}
                  try_files {path} /index.html
                  file_server
              }
          }
        mode: "0644"

    - name: Reload Caddy
      ansible.builtin.shell: sudo systemctl reload caddy
      changed_when: true

    - name: Wait for backend health check
      ansible.builtin.uri:
        url: "http://localhost:{{ backend_port }}/health"
        status_code: 200
      register: health
      retries: 15
      delay: 2
      until: health.status == 200
